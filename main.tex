\documentclass[11pt]{cup-elements}
\usepackage{graphicx}
\usepackage[affil-it]{authblk}

% paragraph formatting
\setlength{\parindent}{0em}
\setlength{\parskip}{0.5em}
\renewcommand{\baselinestretch}{1.5}

\newcommand{\rw}[1]{{\textcolor{red}{[RW: #1]}}} % %RW comment
\newcommand{\edit}[1]{{\textcolor{red}{#1}}} % %edit
\definecolor{armygreen}{rgb}{0.29, 0.33, 0.13}
\newcommand{\aw}[1]{{\textcolor{armygreen}{[AW: #1]}}} % %AW comment
\newenvironment{boxedtext}[1]{%
  \begin{mdframed}[frametitle=#1,
    frametitlefont=\scshape\mdseries\sffamily,
    frametitlealignment=\centering,
    backgroundcolor=black!20,
    hidealllines=true,
    innerleftmargin=11\p@,innerrightmargin=11\p@,
    frametitleaboveskip=0.5\baselineskip,
    innerbottommargin=0.5\baselineskip,
    skipabove=\baselineskip,skipbelow=0.5\baselineskip]
}{%
  \end{mdframed}%
}

\title{Understanding the tripartite approach to Bayesian divergence time estimation}
\author[1,2]{Rachel Warnock} \author[3]{April Wright}
%alphabetical for the time being

\affil[1]{Department of Biosystems Science and Engineering, ETH Z\"urich, Basel, Switzerland}
\affil[2]{Swiss Institute of Bioinformatics (SIB), Switzerland}
\affil[3]{Department of Biological Sciences, Southeastern Louisiana University, Hammond, United States}

\date{}

\begin{document}

\maketitle

%\rw{Are you happy with equal joint co-authorship?} 
%\aw{Yeah, that's fine. Two author papers are sort of weird like that. If you need to be first or senior for any reason, that's fine by me, too}

\section{Introduction}

Phylogenetic inference is common in all facets of biology. 
Estimating a phylogeny is a critical step in many comparative analyses.
The fact that this analysis is common hides its complexity.
When a researcher estimates a phylogeny, they are attempting to reconstruct evolutionary events, such as speciation, that potentially occurred millions and millions of years ago.
In modern phylogenetics, this is often accomplished via the use of an evolutionary model, which ideally describes the generating processes that underlie the data.
No two datasets are exactly the same, in terms of the evolutionary history and forces that generated them \edit{or the way in which they were sampled}.
Therefore, it is important for researchers to understand the \sout{phylogenetic} \edit{data} and evolutionary models that allow us to make phylogenetic inference\edit{s}.
Choosing the best method to build a phylogeny often requires both deep knowledge of the taxonomic group, as well as phylogenetic theory.

The challenge of doing this estimation is compounded when we add in the need to scale phylogenetic trees to absolute time.
An undated phylogeny typically has branch lengths in units that reflect the overall number of molecular or morphological character changes.
Many comparative analyses require those branch lengths to be in units of calendar time, such as years or millions of years.
Dating a phylogeny is often achieved through jointly estimating the tree and the node ages on that tree.
In performing this analysis, researchers usually assume a tripartite model of evolution: one model that describes the accumulation of differences in character data, one that describes the distribution of evolutionary rates across the tree, and a model describing the distribution of speciation events \edit{(node ages)} across the tree \cite{Thorne1998,Kishino2001,Yang2006,Drummond2006}.
In this review, we will discuss performing this analysis using Bayesian methods. 
We focus on models that are used in macroevolution and  paleobiology research.

\begin{boxedtext}{Phylogenetic Tree Basics}

A phylogenetic tree is comprised of \texit{tips} (indicated with circles on panel A), which are the taxa between which you are inferring relationships. These taxa are connected \sout{to} \edit{by} \textit{branches}, which in an undated phylogeny, are typically in units of expected character changes per character. Under parsimony, the branch lengths may be in units of observed parsimony steps on the branch. Branches may also be referred to as \textit{edges}. The branches are connected by \textit{nodes} (indicated with triangles in Panel A), which reflect the most recent common ancestor of two given tips. You may also see nodes in the literature referred to as \textit{vertices}. \rw{I've never heard this term...}
A tree estimated with no time information can be seen in panel A.

In a tree that has been estimated with divergence dating methods, the branch lengths will be in units of calendar time. That is, rather than reflecting an expected rate of character changes per character in the matrix, they will reflect time, often in years or millions of years.
Panel B shows the same tree from panel A, but with branches in millions of years.

\includegraphics[height=6cm, width=7.75cm]{figures/undated.pdf} \includegraphics[height=6cm, width=7.75cm]{figures/scaley.pdf}
\label{fig:undated}

\end{boxedtext}


While this tripartite model sounds complex, it enables researchers to treat each component as a discrete inferential module.
This offers researchers the flexibility to combine different models to suit their data.
Bayesian methods have well-developed tools for testing the fit of model assumptions to our data.
Therefore, using the tripartite model in a Bayesian framework allows us to make a wide range of assumptions, and to test how well those assumptions fit the data we have observed.
Understanding the tripartite framework is also useful for tracing the history of phylogenetic model development, making informed parameter choices, interpreting your results and diagnosing problems with your analysis.

\rw{Somewhere we should consider adding our preference for Bayesian inference, e.g., Bayesian approaches 
for estimating time calibrated trees are currently the only available methods that can incorporate the uncertainty associated with temporal information in a statistically coherent way, meaning that the uncertainty is properly consider during parameter estimation and reflected as part of the output.
Further, Bayesian inference provides an intuitive approach to accommodating uncertainty in other evolutionary and sampling parameters, and incorporating our existing knowledge of parameter values.
}

\section{A brief introduction to Bayesian Inference in phylogeny}

In this review, we will discuss \underline{divergence time estimation} using Bayesian methods. 
These are methods which incorporate prior information and researcher intuition about parameters in our model.
Unlike some other methods, Bayesian methods estimate a sample of phylogenetic trees and values for the parameters of the underlying phylogenetic model.
We can think of Bayesian inference as having three important components: the likelihood, the prior, and the posterior.
Fig. \ref{fig:bayes} provides an overview of how these components are connected via Bayes' theorem to data and the tripartite model of evolution described in this review.

\rw{LH said she didn't think of divergence time estimation and time scaling as interchangeable but I actually do. Now that you've eliminated the term time scaling maybe this doesn't matter?}

\subsection{The Likelihood}

We often think of statistical words in colloquial terms.
For instance, we may think of ``likelihood" in our daily life, as an event being likely or unlikely. 
This is different than in a statistics, when we calculate the likelihood, or probability, of observed data given a particular model.
A model is a mathematical description of a phenomenon.
Models are made up of parameters, which are thought to represent key factors of that phenomenon.
The relationship between parameters is described through mathematical expressions.


In the case of a phylogenetic tree, the generating process may be a complex interplay of biological phenomena and sampling strategies.
Models can have parameters that are meaningful in a biological context, though some may be less clearly biological.
We will discuss in the following sections, the meanings of some common parameters of morphological and molecular character evolution.
We also make assumptions about how age information was generated, such as the age associated with fossil samples or biogeographic events.
In estimating a dated phylogeny, researchers often combine a model of character evolution, with a model that captures the processes of speciation and extinction (sometimes termed macroevolutionary processes) that have occurred over geological time.

\rw{Based on LH and DB's comments I would suggest further rewriting/combining these paragraphs.}
\rw{LH also suggested introducing some of this after we describe the generating processes. Perhaps to simultaneously address this, in combination with some of her comments on the intro, we should explain the generating processes in a bit more deatil in the intro?}

In general, the parameters of a model are treated as \textit{random variables}.
A random variable has an unknown value, for which candidate values will be tested as the tree search proceeds. 
In a Bayesian analysis, different values will be \textit{sampled}, or proposed, for each random variable \edit{from the range of potential values}.
Some variables or model parameters may be \textit{fixed}, or set by the researcher, if the value is known either from an experiment or a literature search.
A common fixed value is extant species sampling --- we often have a strong idea about what proportion of extant taxa in our clade of interest we have included in our analysis.
Values may also be deterministic, or transformed from other variables in the model. \rw{Dave notes that this term is very revbayes specific. Perhaps we can just preferentially refer to these as `transformed variables' (sometimes known as deterministic variables), rather than the other way round?}
An example of a deterministic parameter would be something like a diversification rate, which is typically speciation minus extinction.
In most models, speciation and extinction are estimated on their own, the diversification rate is transformed from the two.
In many analyses, the phylogeny itself is a deterministic variable, being the combination of the topology and branch length parameters.
Values for model parameters are proposed, and evaluated via the likelihood or a combination of the likelihood and the priors.  
In pure likelihood methods, such as maximum likelihood estimation, the combination of fixed model parameter values that maximizes the likelihood of the data given the model is preferred.
Bayesian methods, on the other hand, estimate a pool of solutions that are plausible, taking into account both the likelihood and prior.
In the case of Bayesian methods, the likelihood model is only one component of the estimation.
In maximum likelihood methods, it is the only component. \rw{Consider putting some of this in a box?}

For example, let us assume we have a simple birth-death model in which there is a parameter (birth) governing the rate at which lineages originate, and one (death) describing the rate at which lineages end.
In the case of a likelihood implementation, we would try combinations of values for our two parameters. 
The preferred solution would be the value which maximizes the likelihood of the data given the model.
In Bayesian estimations, \edit{typically} a sample of solutions will be generated, and will be evaluated via both the model and the priors. \rw{I don't really agree with Dave's comment that this is mcmc specific? The posterior is a sample of solutions, irrespective of whether that solution is recovered analytically or via mcmc?}
In the tripartite model for divergence time estimation, all parts of the model (site model, clock model and tree model) will be represented in the likelihood as well as in the prior (Fig. \ref{fig:bayes}).


\subsection{The Prior}

\rw{To do: as per DB's suggestion look into Alfaro and Holder's 2006 perspective on priors.}

Bayesian methods incorporate researchers' prior knowledge and beliefs about the values a parameter may take through the use of priors.
A prior specifies a probability distribution from which the value of a particular parameter may be drawn.
A prior distribution should reflect the belief or knowledge a researcher has about the value of a parameter.
In the case of our simple birth-death model, we may choose priors based on what a previous analysis has discovered about the rates of lineage origination and extinction.


The value of a parameter can fall outside the prior distribution.
Priors can be enforced with varying degrees of strength.
If the data strongly support a value for a parameter that is in conflict with the prior specified, that value can still be supported if the prior isn't strongly enforced.
Priors can also be chosen to offer maximal flexibility in the potential values for the parameter.
For example, a weak intuition about the value of a parameter can be incorporated via a vague prior.
In biology, it is fairly common to see distributions such as the Gamma or Exponential, which can be very flexible, depending on the centrality and/or shape parameters.

Sometimes the distinction between what we call a model and the prior can be difficult to see.
In our example, of a birth-death process, we have two parameters.
Let us say that we expect speciation to be fairly low.
But we aren't sure --- some previous analyses have indicated it may be higher.
We place a flexible exponential(10) prior on speciation, which has an expected value of 0.1 \edit{per lineage per myr}.
Having little intuition about what we expect for the extinction rate, we decide to also use an exponential(10) prior.
But then we read a paper that indicates extinction tends to be very high in this group.
So we start another estimation in which we use a normal prior on extinction rate, with the mean equal to the high value from this paper. 
\rw{Is there any reason this can't also be an exponential distribution?}
These two analyses make different \edit{prior} assumptions about the generating process, even though they incorporate the same parameters. 
In this way, both the parameters and the priors chosen for those parameters, can affect our analysis.

\clearpage
\begin{boxedtext}{The likelihood\, the prior\, and the posterior}

It can be confusing for novices to understand what the likelihood, the prior, the posterior truly mean.
In plain language, the likelihood is the probability of the data given a model.
Without a model, there can be no calculation of the likelihood.

Priors can be set on parameters in the model, specifying distributions from which the value is thought to be drawn.
These distributions are often based on the researcher's intuition, and on information from prior studies.
The posterior distribution is a set of plausible solutions given the likelihood and the prior.
During Bayesian estimation, different values will be sampled for model parameters.
Their probability will be evaluated according to the likelihood and the prior.
Therefore, the posterior is proportional to the likelihood and the prior.
A good solution will often appear in the posterior sample many times.

\end{boxedtext}

\subsection{The Posterior}

The posterior is the outcome of a Bayesian analysis and includes a distribution of plausible for all of the variable parameters in our models, including the topology and divergence times.
This component effectively combines the information from the prior with the likelihood. \rw{DB doesn't think this is a complete enough description of the posterior.}

Values for each parameter will appear in the posterior distribution in proportion to how probable they are, given our model and priors.
The \edit{highest point or points} \sout{peak} of the distribution represents the most probable parameter estimates.
The variance of the posterior distribution for a given parameter reflects the uncertainty in that estimate.
If the variance in our posterior distribution is relatively high this reflects lots of uncertainty in our parameter estimate.
Conversely, if the variance is relatively low, this reflects low uncertainty in our estimate.
Note that low uncertainty does not necessarily mean an answer is correct, just that there is high support for it.
It is also possible to have more than one peak in your posterior sample.
This might indicate that there are multiple solutions that may be feasible given the model and the data.

From the posterior distribution of many standard model parameters (e.g. rate parameters) we can construct credible intervals, which are the Bayesian equivalent of confidence intervals.  
We typically use the 95\% highest posterior density (HDP) interval, which is the spread of posterior values that contains 95\% of the posterior.
The upper and lower limits of the of 95\% HPD are intuitive way of communicating the uncertainty associated with parameters such as rates or node ages.

Summarizing a posterior distribution of trees is altogether more tricky.
There are a variety of approaches to generating summary trees, which use different strategies for capturing the phylogenetic relationships that are best supported by the posterior.
Once we have a summary tree, we can obtain a  support value for each node, based on the proportion of trees in the posterior in which that node also appears. %DB: is there really any other support value for nodes in Bayesian phylogenetics? Rw: no but I don't see the harm in clarifying this?
Much as all models have assumptions, all approaches to producing summary trees have benefits and downsides, especially if there is a lot of uncertainty associated with the tree topology.
We emphasise that the posterior output of Bayesian phylogenetic tree inference is really a distribution of trees and that we should be careful to avoid placing too much faith in any one statistic or summary value from that distribution.
Instead, it is important to understand the underlying models used to generate your tree, and how these may result in uncertainty given the data you have.

Because the prior distribution can affect the parameters estimated, Bayesian methods have a suite of well-developed statistical approaches for evaluating the fit of both the model and the priors to the data.
Called Bayes Factors \cite{Xie2011}, these metrics describe the support for one model, and all its associated priors, over another model. 
These methods weigh the posterior evidence of two models against one another. 
These methods can be used to compare non-nested or mixture models.
It is worth noting, however, that the Bayes Factor can only provide evidence in favor of one model.
It cannot tell a researcher if the model is adequate; that is, capturing important facets of the process of evolution.
Other methods are available that can be used to assess model adequacy \cite{Brown2009, Brown2014}.
\clearpage

\begin{boxedtext}{Summarizing the posterior sample of trees}

Bayesian methods return a sample of phylogenetic trees that are plausible under the model of evolution, and the priors chosen by the researcher. 
This is a nice property: phylogenetic estimation is known to be prone to error when the assumed model of evolution does not match the process of evolution that generated the data.
Because we cannot truly know all the evolutionary forces that generated our observed data, it is wise to take into account uncertainty about the tree and branch lengths.

However, most researchers do still have a need to summarize and display trees. 
Here, we discuss a few common tree summarization strategies.  

\textbf{Maximum clade credibility tree:} In this summary, each tree in the posterior sample is evaluated.
Each clade on the tree is scored for how often that clade is seen in the posterior sample.
The tree then receives a score that is the product of the scores of all the clade scores on the tree.
The tree with the highest score is reported as the summary. 

\textbf{Maximum \textit{a posteriori} tree:} This is the tree with the greatest posterior probability in the sample.
This value does not only account for relationships. 
The posterior will average over branch lengths and other facets of the model, as well.

\textbf{Consensus tree:} This tree displays the most common relationships found in the posterior sample. 
A strict consensus tree displays only the clades found in every tree.
These are not commonly used as they result in little to no resolution in the tree.
Semi-strict consensus trees, such as majority-rule, in which clades that appear in more than 50\% of the trees in the sample are included in the summary tree, are more common. 
This type of summary tree can result in a topology that was not actually sampled in the analysis, but on which all clades are well-supported. 
Because parsimony remains well-used in morphological phylogenetics, and parsimony trees are summarized by consensus, this family of methods is common in the literature.



\end{boxedtext}


%% some stuff about non-identifiability here  commentated out here
%In a conventional Bayesian inference problem, given we have sufficient data, the results should not be sensitive to the priors (depending on the informativeness of the priors and the amount of data).
%Even if there is a conflicting signal between the data and the priors, as we collect more empirical observations, the data should eventually overwhelm the priors. 
%If we an infinite number of observations, the posterior would converge on a point estimates, equivalent to the maximum likelihood estimates.
%Bayesian divergence time estimation is not conventional in this sense.
%Specifically, rate and time are only typically semi-identifiable, because the data we have (morphological characters or sequence alignments) is not directly informative about these parameters. This means we need to use strong prior information to constrain these variables in our analysis. It also also means we can not entirely eliminate the signal from the prior, even if we have an infinite amount of data.

%\section{Tree inference} %-> RW: I was thinking for tree inference, we could have a "box" with anything we considered important to mention  about this.

%For tree inference, we totally ignore time. 
%The output therefore is a tree that contains branch lengths not in calendar time but units that relate to the substitution process (i.e. the process of character evolution).
%The substitution process is typically regarded as the most important aspect of model based tree inference, although we also need a model that describes the probability of observing a given tree.

%Non-time calibrated trees are unrooted.

%\subsection{Tree models for topology inference}

%There are two aspects of trees that  need to be described: the topology and the branch lengths.

%(It occurs to me the concept of the tree model as a generating process is a bit weird in this context.)

%We typical use a uniform prior on the topology, meaning there is an equal probability of observing any possible tree.

%Branch lengths represent evolutionary time and are usually measured in \textit{expected number of substitutions per site/character}. (this is quite a weird way of measuring something).
%We usually use an exponential distribution on the branch lengths. 
%It turns out that in Bayesian inference the tree length is extremely sensitive to the branch length prior - it has a tendency to produce very long trees, in contrast to likelihood. 
%Probably it'll make sense for me to add some results here demonstrating that this is true.
%There are some (Dirichlet) tricks you play. 
%Potentially this doesn‘t matter if we’re only interested in the topology.

%% It does ... let me see if I have some results to display this. Lewis (2001) just kind of notes "it does" and display no results in that paper, lol. 

\section{Substitution models}

The substitution model, sometimes called the site model, describes how characters in the dataset evolve.
These models are called substitution models because they were initially written to describe nucleotide changes.
These models describe how character change accumulates over time, leading to the observed phylogenetic data.
In the context of divergence time estimation, phylogenetic data are typically either morphological or molecular data. 
While molecular and morphological data have very different properties, as will be discussed below, similar methods have historically been used to infer phylogeny from them.

Most data used in phylogenetic estimation has been discrete data.
Discrete data can be broken into non-overlapping categories.
For example, nucleotide sequence data separates cleanly into adenine, cytosine, guanine, and thymine.
Morphological characters are often divided into discrete states \cite{de1985ontogenetic}.
Most simply, these may correspond to an absence state (usually coded as `0') and a presence state (usually coded as `1') \cite{watrous1981}.
They may also correspond to more complex character diagnoses.

There are many models to describe how molecular sequence data evolve over time \cite{Jukes1969, Kimura1980, Felsenstein1981, Hasegawa1985, Tavare1986}.
In most common substitution models, the probability of observing a change from one character state to another is taken to be the product of the \textit{exchangeability} between the two nucleotides at \textit{equilibrium frequency} of the starting nucleotide (i.e., the nucleotide that exists in the sequence, and will be substituted for another). 
The exchangeabilities refer to the probability of seeing a change from one particular state to another.
These are often based on biochemical features of the nucleotide base.
For example, it is unlikely to see a purine (two-ringed nucleotides, adenine and guanine) substituted for a pyrimidine (one-ringed bases, cytosine and thymine). 
This is biochemical --- we are less likely to observe large changes, such as gaining a second ring of carbons on a structure, than we are smaller ones.
Equilibrium frequencies refer to the frequency that we would see each of our character states if we allowed the evolutionary process to run infinitely long (i.e., to equilibrate).
This is based in simple statistics: Even if it is easy to change from one nucleotide to another, if the starting nucleotide is rare, that change will be seldom observed.
It may be easy to transition from an adenine to a guanine.
But if we have no adenines in our dataset, we are unlikely to observe this change over time.
\clearpage


\begin{boxedtext}{Molecules and Morphology}

Nucleotide data tend to have well-defined and discrete properties.
This allows a range of assumptions to be made about what changes we are likely to see over evolutionary time.
In the below schematic, we have several representations of different types of character change.
For nucleotide data, we know that we are more likely to see certain types of change, such as two-ringed bases (purines) transitioning to other two-ringed bases, and one-ringed bases transitioning to other one-ringed bases.
This is represented by thicker arrows connecting these bases.

On the other hand, for morphological data, character states do not carry common meaning across characters.
At one character, changing, for example, from a `0' state to a `1' state may be a small change.
At another, it may mean gaining a complex character.
Therefore, researchers have largely used the Mk model of Lewis (2001) to model these data.
The schematic below shows the assumption of equal change probability between states.


 \includegraphics[height=6cm]{figures/Q.pdf}
\label{fig:Q}

\end{boxedtext}

Making different combinations of assumptions can yield a panoply of molecular models.
The simplest model of sequence evolution, the Jukes-Cantor model \cite{Jukes1969}, assumes only one parameter: the rate of evolution.
The exchangeabilities of this model are equal between all states. 
The equilibrium frequencies are \edit{also} assumed to be equal.
Therefore, under this model, you are as likely to observe a change that adds a second carbon ring to a pyrimidine as you are to observe changes from pyrimidines to other pyrimidines.
On the opposite end of the spectrum, the general time reversible model (GTR) \cite{Tavare1986} allows for six different exchangeabilities, and for each molecular character to have its own equilibrium frequency.
This is a more complex model, but it is often supported as being the correct one for many datasets \cite{abadi2019}.


Bayesian phylogenetics using morphological characters have
historically used a more restricted set of models than analyses of molecular data.
While we may be able to divide a morphological character into multiple states, we may not be able to easily describe how states can transition from one to another over evolutionary time.
Molecular models assume that the biochemical properties of an adenine are the same today as they were in the past, and
that all adenines are the same in different locations in the dataset.
What are the biochemical properties of an absent character?
Does a change from `0' to `1' at character `1' imply the same magnitude of changes as the same change at character `5'?
The lack of consistent meanings to character states has limited the assumptions that can be made about the process that generated morphological data.
Due to the limited number of morphological models available, model testing has not become common in morphological phylogenetics yet (though see an example of empirical model fitting in \cite*{bapst2017}), and understanding the role of morphological model in divergence time estimation is an active area of scholarship. 

Because of the lack of common meanings between morphological character states, those working with morphological characters have largely been confined to working with the Mk model \cite{Lewis2001}.
This model is a translation of the Jukes-Cantor model \cite{Jukes1969} of sequence evolution to morphological characters.
Therefore, it makes the same assumptions about the generating process: that exchangeabilities are the same among all states, and that all states have equal equilibrium character frequencies.
This is a fairly restrictive model, but in a Bayesian context, some assumptions can be relaxed, allowing the user to make a variety of assumptions about the evolution of morphological data \cite{Nylander2004, Wright2016}.
For a more detailed review of these methods, see \cite{Wright2019}. 
Continuously-valued morphological characters have also been used in phylogenetic  \cite{goloboff2006, parins2017} and divergence time estimation analysis \cite{AlvarezC2019}.
These characters are typically assumed to evolve under processes such as Brownian motion and other models that allow for changes to accumulate continuously along a branch.  


Discrete models are often adapted to take into account that characters (nucleotide or morphological) will evolve at different rates. Following a landmark study by Yang \cite{Yang1994a}, most researchers have modeled among-character rate variation (ACRV) as being distributed according to a Gamma distribution.
A Gamma distribution can be manipulated to take a wide range of shapes.
This distribution is then discretized into four (or more) categories and the median rate of each category is used as the rate of evolution for that category.
This allows different sites to evolve according to different evolutionary rates, thereby correcting for different rates at sites.
This practice is common for both molecular and morphological data, though some studies indicate lognormal-distributed ACRV is more appropriate \cite{wagner2011, Harrison2015}. The is because characters that do not vary are parsimony-uninformative and therefore are usually not collected by morphologists. \rw{Now that I think about it I also don't understand this -- what do we gain from a lognormal distribution that can't be achieved with a gamma distribution?}

Regardless of the specifics of a given model, both data types use discrete state continuous-time Markov chains.
`Continuous-time' refers to models allowing change between character states to occur instantaneously at any point in an evolutionary history.
Changes in the character state is not confined to the node; instead, branch lengths on a phylogeny are proportional to the number of expected changes per character along that particular branch. 
In this context, `Markov chain' refers to the  joint probability distribution including all the parameters for the model of morphological substitution, the model of molecular substitution, and the tree and clock models. 
In practice, this is the computer model that we use to estimate the posterior \cite{Hoehna2016b}.

\rw{Shall we consider adding some comments on unobserved changes?}

\section{Incorporating time} %some repetition here for the moment

The site model does not tell us anything about absolute time.
When estimating a tree from character data using a site model, the estimated phylogeny is not scaled to time.
As discussed above, a branch length on a tree in a Bayesian model is the number of expected substitutions per site.
This is a rate: the number of substitutions multiplied by the units of time.
It is an expected rate, because Bayesian and likelihood methods allow for hidden state changes.
Therefore, the number of expected changes could be larger than how many we observe in the data we collected.
Ultimately, we want to be able to disentangle this rate and time in order to estimate time since divergence on a tree.
We need to convert the rate into \textit{expected substitutions per site per calendar unit time}.


To tease apart rate and time, we either need to know the average substitution rate (this is rarely known outside \edit{the context} of DNA characters for some model organisms, see early demonstrations of difficulties applying a global clock in \cite{gaut1992, MOOERS1994, bromham1996, rambaut1998}) or we need to calibrate the substitution rate using temporal information from elsewhere.
Temporal information typically comes from  fossil sampling times.
Alternatively, this info can come from biogeographic data, or from human-recorded data in the case of phylogenetic problems concerning recent timescales.
This information is then modeled using hierarchical  Bayesian models to estimate time since divergence.
\edit{The model is hierarchical because it links together different sub-models (i.e. the substitution, clock and tree models) (see box).}
There are two key model components required to date a phylogeny: the clock model and the tree model.
Rate and time are often only semi-identifiable.
A model is \textit{identifiable} when different values for the parameters generate different probabilities for the observed data.
On the converse, a model is not identifiable when multiple sets of parameters could generate the same probabilities of the observed data.
In this case, we may be unable to identify, or distinguish, the true parameter values.
In practice, this means we need to put strong prior information on the average substitution rate and times. 
A consequence of this that the results will be very sensitive to these prior choices.
As a result, it is important for biologists to understand each of the component pieces (the clock and tree models) in order to make good choices in selecting and parameterizing a prior.

We will begin with the clock model.


\section{Clock models}
The function of the clock model is to describe the way the rate of character change varies, or does not vary, across the tree.
These models can describe different schemes of variation in the rate of evolution across the tree.
These range from  every branch having the same rate of evolution to every branch having its own rate.
Each of these models implies specific evolutionary dynamics.
Below, we will review some common clock models, which can apply to molecular or morphological data.

\subsubsection{Strict Clock}
In the earliest days of divergence time estimation, a strict clock was used \cite{Zuckerkandl1962, Zuckerkandl1965EvolutionaryDivergenceConvergence}.
Under the strict (or global) clock model, we assume that the rate of character change is constant across time and that the same rates applies to all branches in the tree.
This model adds one parameter to the overall model, describing the conversion between \edit {the rate of} character change \sout{rate} and \sout{an} absolute time \sout{branch length}.

\subsubsection{Uncorrelated Clock}
Of course, most clades do have variation in the rate of evolution over time. 
A wide variety of clock models have been developed to describe how this variation manifests.
One common family of clock models is the uncorrelated relaxed clock model.
`Relaxed' refers to the clocks not being strict: any model that is relaxed will allow rate variation across the tree \cite{Drummond2006, Drummond2007}.
`Uncorrelated' means that the rate of evolution on a particular branch is not dependent on the rates of evolution of its neighbors or ancestor.
In this family of models, rates are typically assumed to be drawn from some distribution.
The most common of these is the uncorrelated lognormal clock model (UCLN).
Under this model, shown in Fig. 1, the rate of any particular branch is assumed to be drawn from a lognormal distribution.
The lognormal is a popular distribution in this type of analysis, as it implies most branches will have low, but typically non-zero, rates of character evolution. 
Each branch has an independent draw from this distribution, meaning that the rate of a particular branch may be very different from its neighbors.
The parameters of the lognormal distribution can be fixed, or can be estimated themselves (i.e. are hyperparameters).
While the lognormal distribution is the most common distribution for these types of uncorrelated clock analyses, other distributions can be used, such as the Gamma distribution.
A Gamma distrobution, as seen on Fig. 1, implies some branch rates are very close to zero.

\begin{boxedtext}{Hierarchical Models}

The tripartite approach to divergence time estimation is what is termed a \textit{hierarchical model}. 
%This is a somewhat confusing term. 
Hierarchical models are models in which variation may be described by different submodels.
In the case of divergence time estimation, the character data is described by one model, such as the Mk model.
The distribution of evolutionary rates across branches is described by the clock model.
Finally, the distribution of speciation, extinction and fossil sampling is described by the tree model.
Together, these three components are used to estimate a tree, branch lengths in units of time, and other relevant model paramters.

This term may be confusing, as model components may have a hierarchy of priors. 
For eample, if we placed a lognormal distribution with shape parameter 10 on the mean clock rate, this is a prior.
If instead, we placed an exponential prior on the shape parameter, that exponential prior is called \textit{hyperprior}.
This, while a hierarchy of priors, is not a hierarchical model. 

\end{boxedtext}
\clearpage

\subsubsection{Autocorrelated Clock}
The idea of rates being independent draws not dependent on the rates of the ancestor may strike some as odd. 
Much of the literature on clock models is from molecular data and molecular clocks.
Molecular clocks are influenced by a variety of factors, such as generation times, population sizes, and metabolic rates \cite{bromham1996, gaut1992}.
It would be reasonable, then, to expect that close relatives have similar evolutionary rates if they share these traits.
In autocorrelated rate models, the rate of a descendent branch is drawn from a probability distribution \cite{Aris-Brosou2002}  centered on the rate of the ancestor's branch. 
Different distributions can be assumed to allow the descendent's rate to be more different, or to force it to be more similar. 
Identifiability, however, is a problem with these models, requiring the use of strong priors on rate shift locations and size \cite{Rannala2002, Ronquist2012a}.

Autocorrelated clock models can also be continuous.
A continuous autocorrelated clock model assumes that, again, the distribution from which the rate of a descendent is drawn is centered on the rate of evolution in the ancestor.
But under these models, the variance is typically proportional to the substitution rate of the branch. 
A lower rate allows less variation, and a longer branch will have more.
More sophisticated assumptions can be made under these continuous relaxed clock models, such as the variance or mean in rates itself evolving across the tree \cite{Thorne1998, Kishino2001, Thorne2002, Aris-Brosou2002, Aris-Brosou2003}.

\subsubsection{Local Clocks}

Random local clocks behave in some ways like a strict clock, and in some ways like a relaxed clock. 
A random local clock allows a subtree to have its own rate of evolution \cite{yoder2000}. 
The branch subtending the subtree is the position of the shift between one clock rate and a new clock rate. 
Generally, the new clock rate applies to the whole subtree, without relaxation.
The number of local clocks can vary between zero (one strict clock) to the number of branches on the tree (a fully relaxed clock).
Both the number of clocks that describe the tree and the location of the shifts from one clock to another are sampled during the MCMC in implementations of this model \cite{Drummond2010}. 


\subsubsection{Other Models of Evolutionary Rate Variation}

As has been seen above, breaking up the branches of a tree into separate rate classes can be accomplished in many ways.
Some have more straightforward biological interpretations, some have less. 
Another approach is to use a mixture model.
Mixture models assume that there is substructure in a population of data.
In this case, our population of data are branches that evolve under different rates.
While the biological causes of those rates may differ, branches evolving under similar rates can be modeled together. 
Under a mixture model, the branches can be broken up in to \textit{n} categories.
\textit{n} may be one category, in the case that a strict clock is favored, or it may be many more.

Mixture models may be finite or infinite.
In a finite mixture model, the number of different rates is specified \textit{a priori}. 
In this case, while there is a defined number of categories, which branches belong to which categories is estimated.
On the other hand, a mixture model may be infinite.
In this case, the researcher does not specify a number of categories \textit{a priori}, and the number is estimated during the phylogenetic estimation \cite{Heath2012a}.
In these models, a Dirichlet Process Prior is used to sample both the number of categories, the average rate for each category, and which branches belong to that category.
A DPP can be more concentrated (assumes fewer rate categories) or more diffuse (assuming more categories).
Therefore, without assuming an explicit biological mechanism, they can be compatible with a number of biological scenarios. 

\rw{I wonder about taking up LH's suggestion of discussing the amount of data required and how to test between different clock models?}

\section{Tree models for time-calibrated tree inference}

%Think about adding an explaining about rooting

Tree models are an extremely important and often poorly-understood component of divergence time inference. 
They \edit{incorporate} \sout{capture} assumptions about the tree generating processes and provide us with an expression for describing the probability of observing a given time-calibrated tree. This allows us to obtain a distribution containing the most likely trees, in terms of tree \sout{shape} \edit{topology} and branch durations, separate to any information we gain from our sequence or character data.
They also provide a framework for incorporating temporal evidence into our analyses --- that is, we use the tree model to propose a plausible range of ages for the nodes in our phylogeny.
%\sout{It's worth emphasising that any explicit information about \textit{absolute} time is entirely contained within the tree model component of divergence time inference.}
% This is a subtle point. Perhaps we want to add in something about what this means. Maybe:
Note that the substitution model provides a rate-based estimate of substitution. The clock model models how rates are distributed across the tree. But only the tree model incorporates fossil age information.
This information is used calibrate the substitution rate in combination with the substitution and clock model components. %in units of \textit{expected substitutions per site per calendar time unit}
Most often temporal evidence comes from the age of sampled fossils \cite{Parham2012,Heath2014}, but it can also come from biogeographic evidence \cite{deBaets2016,Landis2016}. \rw{LH says this paragraph could be clearer but I'm actually not sure how to do this...}

Approaches to calibration can be placed into two useful categories: \textit{node-dating} and \textit{tip-dating}. 
These broadly reflect major differences in how age information is combined with or incorporated into the tree model.
Briefly, node-dating assumes that our tree represents the relationships between living (extant) species only, and we constrain the ages of internal nodes using information from the geological record% to calibrate the substitution rate
, without directly considering extinct or fossil samples as being part of the tree.
In contrast, tip-dating directly considers fossil samples as being part of the tree.
In this section we discuss popular tree models in more detail and describe how they are used in both node- or tip-dating scenarios.

Previously, we noted that the distinction between the model and the prior can be unclear or inconsistent. It is perhaps most inconsistent when it comes to how different researchers refer to the tree model.
The tree model is frequently referred to as the tree prior, and in combination with the calibration information, researchers often talk about the resulting prior distribution on node ages. %todo I can cite a couple of my papers here, so as not to create the impression that I'm picking on anyone. 
\sout{However, some researchers have referred to the component used to calculate the probability of observing a given time tree as the phylodynamic likelihood \cite{Boskova2018}.}
Some of this inconsistency can be attributed to the history of different models used for phylogenetic dating %across subdisciplines 
and whether we consider the fossil ages used during inference as data.
Under the node-dating approach, fossil sampling times are used to constrain the age of a node.
In this framework, they are not data in the sense that \sout{sequence} \edit{morphological character} data are --- the generating process is not explicitly modeled, but instead, the data are used to bound the age of a node.
As we move towards more mechanistic approaches to dating that, for example, model the process of fossil recovery (described below), it becomes clear that the fossil ages are actually data, \edit{in addition to  morphological characters}.
The terms process- and prior-based have also been used to distinguish between approaches that explicitly model the  process that generated the temporal evidence used during inference and those that do not \cite{Landis2016}. 
Here, we use the term tree model to refer to all the models that underlie these different approaches.
This term avoids lending to the largely false impression that we can overrule the signal that comes from the tree model given we have sufficient character data. 
It also underscores the existence of a large and important family of models used in Bayesian divergence time inference.
Many studies have shown that the tree model and/or the calibration information combined with the tree model have a major impact on Bayesian estimates of node ages (e.g., \cite{Ho2009,Warnock2011,OReilly2015,matzke2016,Matschiner2017}).

\subsubsection{Models of speciation, extinction and sampling}

The most intuitive models are those that capture the processes we believe gave rise to our data and include parameters with tangible, biological meaning.
An advantage of process-based tree models is that they can provide a better description of our data and also allow us to quantify other key parameters of interest, such as speciation (birth) and extinction (death) rates, in addition to the tree topology and divergence times. %origination
%The term phylogenetics is used to encompass analyses in which the aim is to infer the tree and/or divergence times. Phylodynamics is used to encompass analyses in which the aim is to quantify the underlying dynamics of the process that gave rise to our tree.
%This term is more commonly applied in the context of epidemiology but can also be applied to macroevolution, where the model typically includes the speciation (birth) and extinction (death) processes.
The most widely used tree models in macroevolution are birth-death process models, which refers to a huge family of models, at the heart of which are the speciation and extinction processes. 

The simplest \sout{birth-death} model assumes speciation is constant over time, \edit{that we have no extinction,} and that we sample a representative of every individual lineage \cite{Yule1925}.
This is termed a pure-birth model.
\edit{The most straightforward extension incorporates  extinction \cite{Kendall1948}.}
Restrictive assumptions such as no extinction or constant rates of speciation may be reasonable in small and recent clades, but are likely not very reasonable over long time intervals and or large groups.
In reality, we additionally almost never reach complete species sampling.
Some of the most important model developments in this area have therefore been to relax the assumption of complete sampling, both at the present and in the past.
Sampling living species at the present and sampling either living or extinct species from the fossil record are typically treated as distinct processes.
In particular, it is useful to think of extant species as being sampled in the present ($t=0$) with a given probability, which could be anywhere between zero and one, depending on the taxonomic scope of the study.
In contrast, we tend to model fossil recovery as a continuous process, with an associated rate parameter.  

Tree models capture the underlying processes (speciation, extinction and sampling) that result in the \textit{complete} tree, including sampled and non-sampled lineages. But to calculate the probability of observing the  \textit{reconstructed} tree (the tree representing the relationships between sampled individuals only), we need to account for the fact that we only sample some subset of lineages.
For example, if we only sample living species, but assume both speciation and extinction have occurred, we need to use the expression for the probably of observing our tree, given we only sample species at the present and none in the past \cite{Thompson1975,Gernhard2008, Stadler2009}.  Similarly, if we only sample some subset and not all living species, we need to take this into account using the expression for a model that incorporates incomplete extant species sampling \cite{Yang1997,Stadler2009}.
Figure \ref{fig:birth-death} shows examples of the complete versus reconstructed tree for different birth-death process models.

In grappling with the details of some of these models it can be useful to think of these models as being nested and the simpler models as being special cases of more complex variants.
For example, a birth-death model that does not incorporate extant species sampling, is simply a special case of a model that does incorporate this process, in which we assume extant sampling is complete. 
%Similarly, birth-death models that exclude the fossil recovery process, is simply a special cases of the FBD process, in which we assume the fossil recovery rate is zero. 

\rw{I haven't shown any graphical models for these; I'm thinking this might not be needed here?} \aw{This is something I've waffled on myself - I wouldn't mind showing a graphical model in the morphological models section to illustrate which parameters and assumptions are typically treated as fixed and which are often treated as stochastic. If we're going to go down the path of showing graphical models, I think we need to show more than just one to reinforce their nature and utility, since they are often not a construct used heavily in paleo.}
\rw{Maybe wait and see what feedback we get? I think a separate paper on this topic could be in order.}

\begin{boxedtext}{Maximum Likelihood and Bayesian Esitmation}

As discussed in the section `The Likelihood', the probability of the data is calculated given a model. 
In maximum likelihood estimation, models are proposed, and the likelihood of the data is calculated given each of those models.
The model that gives the best likelihood is considered to be the `best'.
This is generally a point estimate returning one tree, one set of branch lengths, and one set of other model parameters.

Inference of undated trees from morphological data can be accomplished in many pieces of maximum likelihood software, such as PAUP, RAxML, IQTREE, and GARLI (cite these).
Estimation of dated trees incorporating morphological data has mostly been accomplished in a Bayesian context, using software such as MrBayes, BEAST, BEAST2, MCMCTree, and RevBayes.
While there is no reason models such as the FBD cannot be estimated using maximum likelihood, in practice, there \sout{is often wide uncertainty on many model parameters, which can cause misleading inference when distilled to a point estimate} \rw{I would say, it not straightforward to incorporate the uncertainty associated with parameters within a likelihood framework}.
\end{boxedtext}


The assumptions made by different tree models are important because they can result in very different distributions of plausible trees.
Different combinations of the speciation, extinction and sampling parameters give rise on average to different tree shapes, which determine the most probable waiting times between ancestor and descendent nodes 
in the reconstructed tree.
Let us consider the impact on a reconstructed tree representing the relationships among a set of living individuals (i.e. the tree includes no extinct samples). 
If we have low extinction relative to speciation and complete sampling at the present, the tree is more likely to have shorter internal \edit{non-terminal} branches and more evenly distributed speciation events.
In contrast, if we have high extinction relative to speciation, the reconstructed tree is more likely to have longer internal branches and on average older node ages. 
This is because extinct species are absent, so more speciation events are missing from the reconstructed tree, and there is a higher chance we have to go further back in time to find the speciation event linking any of our extant samples.
Relaxing the assumption of complete species sampling at the present further increases the chances of having longer internal branches and older node ages, for the same reason that we are more likely to be missing speciation events.

Note that we do not have to fix the speciation, extinction and sampling parameters. 
With the exception of extant species sampling, these values are rarely known very precisely. 
However, trees constructed from sequence or character data are informative about the underlying diversification and sampling processes that gave rise to our data.
Since different parameter combinations result in distinct distributions of trees and not all combinations are equally likely to result in the same tree shape, phylogenetic data actually allows us to estimate the speciation and extinction rates if these parameters are explicitly part of the tree model. 
We typically use priors to constrain these parameters, and these can be vague or informative, depending on whether we have some prior information available about these values from elsewhere.

%\subsubsection{Node dating}
The tree model describes the processes that generated our tree but does not directly provide information about absolute time %(unless the speciation and extinction rates are known exactly)
--- this typically has to come from elsewhere.
In the node-dating scenario, the tree represents the relationships between living samples and we tend to use a tree model that includes extant species sampling only, excluding the process of fossil recovery.
Temporal information from the fossil record is instead incorporated through the use of \textit{node calibrations}. 
For one or more internal nodes in our phylogeny we may have information about the age of the speciation event based on fossil or other geological evidence.
For example, for a given pair of lineages, the age of the first appearance of either one of these lineages represents a minimum (i.e. younger) bound for the age of the node separating them.
We can represent the uncertainty in the age of this node using a probability distribution. %LH: would it be an idea to discuss what are the common prob distributions considered (and why)?
This information is combined with the tree model to produce a distribution of trees that have branch lengths in units of absolute time.
Although node dating has been widely used in divergence time estimation, especially in molecular dating studies, it is somewhat less biologically intuitive than an explicit model of diversification and fossil recovery.
Node-dating approaches do not model the process of fossil recovery that gave rise to the fossil evidence used to constrain the timescale.
This leads to technical challenges combining node calibrations with the tree model and in interpreting the resulting distribution on node ages \cite{Heled2012,Warnock2015}.
Another issue with this approach is that it requires assigning a fossil age to a fixed node in the extant species tree, ignoring the potential for phylogenetic uncertainty in the placement of the fossil species.
\edit{The challenges of selecting different prior distributions and the problems associated with node dating have been described in detail elsewhere?}

In tip-dating we consider extinct samples explicitly as being part of the tree and the temporal evidence used to constrain the age of the tree comes from the age of the extinct tips \cite{Ronquist2012a}.
This approach was initially proposed for a scenario in which we have phylogenetic data available for a set of fossils (typically morphological) that overlaps with the data available for living species (typically morphological and molecular). %LH: what if the morphological data is highly non informative, or sparse for combining fossil and extant species? 
It has the advantage that we can recover the position of fossils along with  living species and the phylogenetic uncertainty associated with the placement of fossils used for calibration will be reflected in the uncertainty of estimated node ages. 
For this reason, tip-dating is sometimes referred to as \textit{total-evidence} dating --- although it will always be possible to include additional sources of evidence!
This approach can also be applied to groups of extinct species, meaning we have no extant representatives, and for which we only have morphological character data available.

To include fossil samples as part of the tree, we need to account for sampling through time and ideally we want to use a tree model that incorporates the process of fossil recovery.
The possibility to incorporate extinct species sampling came much later in the history of birth-death models used for tree inference in macroevolution \cite{Stadler2010}.
One technical issue is that when we think of trees used to represent relationships among fossil species in palaeontology, we usually think of each species as representing a separate tip in the phylogeny.
However, this does not match a continuous model of fossil recovery particularly well.
In the context of birth-death models, what this would mean is that at every sampling event the lineage was terminated and therefore left no descendants.
The \textit{fossilized birth-death} (FBD) \textit{process} is an extension of the models described above that incorporates the fossil recovery process and provides an expression for the probability of observing a tree with samples recovered along internal branches \cite{Stadler2010,Heath2014,Gavryushkina2014}.
Extinct samples can either occur on terminal branches or along branches leading to other sampled descendants, referred to as \textit{sampled ancestors}.
Similarly to tree shape, both the distribution of fossil sampling times and the proportion of extinct samples that are sampled ancestors are linked to the speciation, extinction and sampling parameters \cite{Gavryushkina2014}. 

A major advantage of explicitly modelling the fossil recovery process is that it creates the potential to incorporate much more evidence into divergence time estimation, in contrast to alternative models used to date trees.
For instance, we now have the possibility of including extinct samples with or without character data.
If sequence or character data are available for an extinct sample we can also recover its topological position \cite{Zhang2016} and even assess the probability that it was a sampled ancestor \cite{Gavryushkina2016}.
However, all known dated samples are valuable for divergence time inference using the FBD model, even if they are not associated with any character data, because the distribution of fossil sampling times is informative about the underlying diversification and sampling parameters.
We emphasise that without character data phylogenetic position can not be recovered, even though the fossil will be considered as part of the tree during inference.
But even without character data, we can still have knowledge that a given fossil belongs to a specific clade represented by a subset of nodes in our tree that can be used to inform topological constraints. %an empirical example would be good here. %LH: how often have people had a horrid mxiture of data where some fosisls have characters and others are just asummed to be part of a clade plus some incompletely sampled extant species with some sequence data? 
An analysis under this framework could therefore combine extant species associated with molecular and/or morphological data, extinct samples associated with ancient DNA and/or morphological data, and any other fossil associated with age information that can be assigned to any node in the tree. 
%In some cases the phylogenetic affinity of a fossil could be entirely unknown but it can still be included.
Samples can include stem group fossils, which expands the history of the group that can be dated during inference.
This is in contrast to node dating, where the tree typically includes extant representatives only, meaning we can only  estimate ages within the crown group. 
Of course the FBD model can also be applied to groups of species that are entirely extinct, and in this context we also have the opportunity to include samples both with and without character data.

When we start considering fossil samples as being part of the tree generating process, it becomes important to consider what each sample in our tree actually represents \cite{Hopkins2018}. 
In the fossil record, a species will be represented by one or more fossil occurrences.
An occurrence could represent a single specimen or multiple specimens from the same locality.
Further, the age of each occurrence will be associated with an age range, reflecting imprecision in dating techniques, which we refer to as the \textit{stratigraphic age} of an occurrence.
This uncertainty can be accounted for by placing a prior distribution on the age of the fossil, instead of treating the age as a known variable \cite{Drummond2016,BaridoSottani2019a}.
However, this is distinct from the observed duration of a species over geological time, beginning with the first (oldest) appearance of the species in the fossil record and terminating with the last (youngest) appearance, known as the \textit{stratigraphic range} of a species.
If only a single occurrence is known then the first and last appearance of that species will be represented by the same sample.
Of course the true duration of a species, beginning with speciation and ending with extinction, extend beyond these observed time points. 

How are these processes reflected by the FBD model?
The FBD model does not incorporate information about species through time.
\sout{The model assumes a budding speciation process, in  which each speciation event gives rise to a single descendant species.}
All birth-death models discussed so far make \sout{this} \edit{the} assumption \edit{that each speciation event give rise to a single new lineage, which is equivalent to a budding speciation process}. 
\edit{However,} at each speciation event the model is agnostic about which of the two descendant branches actually represents the ``new'' species.
This is perhaps not obvious as we tend to drawn trees as bifurcating structures.
Further, a potential outcome of the FBD process, as it was originally defined, are trees with multiple samples recovered along internal branches.
These best correspond to the description of fossil occurrences provided above, in contrast to stratigraphic ranges. 
To incorporate information about species through time it is better to use the FBD \textit{range} process \cite{Stadler2017}.
This model is more explicit about how species are defined with respect to the branching process and captures the generation of stratigraphic range data, as opposed to occurrence data.
Further variations of FBD range model also create the possibility to account for alternative modes of speciation, in addition to budding. %not sure if we want to describe these options in any detail

One benefit to using a unified model of macroevolution for divergence time estimation is that extensions to the model can be written out and tested.
A number of such extensions have been published.
Perhaps two that are especially important to note relax the assumption of constant speciation, extinction or fossil recovery through time. 
The FBD \textit{skyline} models (of which there are several) allow rates to vary across time bins, meaning we can recover speciation and extinction rates during different geological intervals \cite{Stadler2013b,Gavryushkina2014}.
\textit{Multitype} or \textit{multistate} birth-death models allow for rate variation across branches, such that different subclades can be associated with different diversification and sampling parameters \cite{Kuehnert2016,BaridoSottani2018}.
We can also also relax the assumption of uniform (random) extant species sampling.
In many empirical trees, especially those that encompass higher taxonomic relationships (e.g. between orders), extant representatives are selected to maximise the diversity, rather than at random. 
This approach to sampling living species is sometimes known as diversified sampling and has been incorporated into birth-death models, in combination with \cite{Zhang2016} and without \cite{Hoehna2011} extinct species sampling.

%\rw{we could perhaps describe the subtle difference between the FBD models in Tracy versus Sasha's paper. I would say let's leave this.} 



\subsubsection{The uniform tree model}

Uniform tree models make the assumption that for a given set of taxa all possible trees are equally likely, and are available for both unconstrained and constrained (time-calibrated) tree inference \cite{Huelsenbeck2001a,Ronquist2012a}.
For time-trees this model is used for tip-dating rather than node-dating \cite{Ronquist2012a}.
Fossil species are treated as extinct tips and sampled as part of the tree.
Age information is incorporated through the fossil ages and an upper bound is applied to constrain the maximum age of the root.
Internal node ages are drawn from a uniform distribution, satisfying the age constraints imposed by the root and tip ages.
An advantage of this model is that it makes fewer explicit assumptions about the diversification, and the fossil and extant species sampling processes. 
In this sense, the tree uniform model is more straightforward, but has the disadvantage that it can not be used to co-estimate diversification parameters.

In theory, given we have sufficient character data, the morphological %and/or molecular 
data in combination with the terminal fossil ages should be informative about the substitution rate, and we should be able to recover the correct branch lengths, irrespective of the root constraint \cite{Ronquist2012a,Klopfstein2019}.
In reality, morphological datasets tend to be very small and this can result in the root constraint having a large impact on the results \cite{matzke2016}.
If the character data are not sufficiently informative about the substitution rate, we tend observe that the older the root constraint, the older the node ages we recover, reflecting the uncertainty associated with the rate parameter.
Although uniform tree models are sometimes referred to as uninformative tree priors, this is somewhat misleading if we consider the influence of the root constraint and the potential negative impact of ignoring sampled ancestors \cite{Gavryushkina2014}.

\subsubsection{Coalescent tree models}
Another large family of tree models used to describe the generation of time trees are coalescent models. These are typically used to model the evolution of genes within a population. 
In this context, the tree typically represents a succession of non-overlapping generations and each branching point represents a \textit{coalescence event}, which is the point at which two genes in a population last shared a common ancestor \cite{Kingman1982}.
Time to coalescence will be a function of population size over time --- the larger the population, the more likely you have to go further back to recover the ancestor of two individuals. %bother mentioning mutation rate? \aw{I think it's OK not to - this is important to sketch in generality, but I think likely to be a bit beyond the ken of most paleo folks}
Similarly to birth-death models, coalescent models have also undergone an enormous amount of development and provide flexible options for describing population growth \cite{Beerli2001, Drummond2005, Mashayekhi2019}. %For example we can relax the assumption of constant population size through time

Although coalescent models can incorporate extinct tips, we do not tend to use these directly to describe the evolution of species, but they can be important in estimating species trees and divergence times from genetic data. %individual gene trees.
Trees based on individual genes can be quite different from the true underlying species history. 
This occurs when coalescence events between individuals belonging to populations of different species are older than the speciation event.
This scenario is known as \textit{incomplete lineage sorting} and can lead to a mismatch between gene and species trees.
Following speciation it takes time for genes to become sorted across distinct species populations, such that genes trees  eventually reflect the species tree \cite{Maddison2006}.
This interval of time depends on several factors, including population size, and can be extremely long (e.g. populations of humans and chimpanzees still share genetic differences). 
However, the mismatch between gene and species trees can actually persist forever if genes do not become sorted before subsequent speciation events \cite{Xu2016}. 
Mismatch is most likely to occur when the branches separating speciation events are very short, irrespective of the timescales involves. This scenario creates a huge challenge to inferring the true species tree.
Discerning the relationships between the major lineages of birds is a good example of this issue --- these events happened almost 66 myr but the internal branches in this portion of the tree are extremely short, and as a consequence different gene trees produce conflicting topologies \cite{Jarvis2014}.
In the face of considerable conflict, identifying a consensus is not straightforward. 
%In particularly problematic cases, we can not simply get around this issue by concatenating genes.
One solution it to explicitly model the evolution of genes, in combination with the speciation process, under the \textit{multi-species coalescent model} \cite{Heled2010}.
In this framework, we can apply a separate coalescent model to each gene in our dataset, and we model the speciation process using a birth-death model. 
We effectively assume that the gene trees are embedded within the species tree.
We can use the FBD model for the species tree, meaning we can also incorporate extinct species, with or without molecular and/or morphological data \cite{ogilvie2018}.
If we do have morphological characters and assume that morphology follows the species tree history, rather than being described by a coalescent model, we can use the species tree model for our morphological data partition.
This is a good example of the hierarchical and extendable nature of phylogenetic tree models, but also showcases a level of complexity that will not always be necessary.

%hybridization

\subsubsection{Biogeographic dating}

Temporal evidence for the age of a node can also come from the geological events linked to speciation \cite{Ho2015,deBaets2016}.
For example, the current biogeographic distribution of living taxa may indicate that species divergence is tied to specific tectonic events that likely resulted in genetic isolation, such as island formation or the break up of continents that existed previously in earth's history.
This approach is especially useful for taxonomic groups with a sparse or non-existent fossil record.
Age information can be incorporated using a node dating approach, where the of biogeographic events are used to inform the calibration distributions, and the tree generating process can be described using a birth-death model.
One challenge to this approach is establishing a definitive causal link between tectonic and speciation processes, especially if events happened a long time ago (e.g.\ the breakup of Gondwana).

%It relies on information about the biogeographic distribution of species, sometimes in combination with evidence from the corresponding molecular phylogeny.
%Further, major tectonic events are often  protracted rather than instantaneous events, and establishing the age range during which topological changes became a barrier to dispersal or gene flow is typically not straightforward.}

More recently, process-based models have been introduced for biogeographic dating and tree inference \cite{Landis2016,Landis2019}.
This approach is conceptually similar to birth-death models that incorporate the fossil recovery process, in that they explicitly incorporate a model of the evolution of biogeography.
In this setup, we have information about the distribution of living species at the tips of our tree, and a model of tectonic history that incorporates age information. 
Species are allowed to disperse between areas with a given rate, which can depend on the current state of the tectonic configuration.
For example, a species can not disperse to an island before the island exists. 
Similarly, the potential for dispersal between two continents will depend on their connectivity.
Thus, the probability of the tree and divergence times is linked to the biogeographic model.
An advantage of this approach is that we do not need to make fixed assumptions about the link between biogeographic scenarios and speciation.
Instead, we can use this approach to test among biogeographic hypotheses --- not all histories will be equally likely to have produced the current distribution of living species.
So far this approach has be used to date trees of extant species only, however, future extensions could potentially account for the biogeography of extinct and fossil samples.
In principle we could combine biogeography with models of diversification and fossil recovery. 

\rw{We should something -- maybe even a full section -- on linking different aspects of sub-models. e.g. like the work Will has been doing.}

\section{Conclusions}

Bayesian divergence time estimation is commonly performed in a tripartite framework.
One model describes the process the researcher believes generated our character data.
One describes the manner in which the researcher believes rates of evolution are distributed across the tree.
The final model describes the extinction, speciation and sampling events that led to the tree observed.
Each of these components has its own parameters, which are believed to describe the process that generated the data.
Each can have priors, which describe the distribution of values we expect a parameter to take.


This framework enables nearly endless combinations of assumptions that a researcher can make about their data.
The goal of this review has been to explain some common assumptions, and what they mean. 
It is by no means exhaustive.
There are more assumptions that could be made, and modeled by researchers.
This new tripartite framework can be improved by close collaboration between geologists, organismal experts, and phylogenetic methods specialists. 
We hope that in explaining some of these common assumptions, researchers will feel empowered to look at their own data and see where methods can be improved, and to seek collaborations to create a new generation of process-driven methods. The challenge for both empirical researchers and method developers will be to identify important model violations, and to gauge the level of complexity necessary to obtain reliable and meaningful results.

%Beyond this, the neat thing about process-based tree models is that they are (in theory) endlessly extendable, such that we can construct hierarchical relationships linking the diversification and sampling processes to any number of external variables through the use of priors.
%However, despite exciting opportunities created by using more explicit process-based models, and in particular modeling the process of fossil recovery, the results will inevitably be sensitive to the model assumptions. 
%In particular, serious model violations will lead to erroneous estimates of divergence times.

\rw{I just thought, I wonder if its worth explaining that we can fix any of the parameters, including a whole component of the tripartite model, such as the time tree, and estimate the parameters of another?} 
\aw{this might be a good call-out box. This might also be a good thing to put in a graphical models for paleos MS - that we are enabled by graphical models to make any stochastic node into a fixed one}

\clearpage

%Further incorporating biogeographic information associated with fossil samples into this framework will also be valuable, as emerging evidence underscores the importance of biogeography in understanding patterns of biodiversity in the fossil record.

%A different set of tree models are required to describe the generation of non time-calibrated unrooted trees. -> refenence to box?

\begin{figure}
\centering
\includegraphics[width=\textwidth]{figures/bayes-theorem-v2.pdf}
\caption{\footnotesize See following page for figure legend.}
\label{fig:bayes}
\end{figure}

\clearpage

\caption{\footnotesize \textbf{A tripartite model for Bayesian divergence time estimation.}
The top panel shows the key ingredients required during inference.
The data used to generate time calibrated trees: molecular or morphological phylogenetic characters, and age information, typically fossil sampling times.
The model includes the substitution (site) model, which describes the evolution of characters, the clock model, which describes the distribution of evolutionary rates across the tree, and the tree model, which describes the distribution of speciation events across the tree.
Bayes theorem is presented in the middle panel. 
The bottom panel illustrates how everything comes together for the Bayesian estiamtion of divergence times.
}

\clearpage



\begin{figure}
\centering
\includegraphics[width=\textwidth]{figures/Distributions.pdf}
\caption{\footnotesize See following page for figure legend.
}
\label{fig:distn}
\end{figure}

\caption{\footnotesize A schematic showing different clock models, and what they mean for the distribution of evolutionary rates across the tree. Row one shows an uncorrelated clock, with branch rates drawn from the exponential distribution. Because this clock is uncorrelated, a descendent may have a very different rate of evolution than its ancestor. In the second row, an autocorrelated clock, rates of evolution in the ancestor and descendant are expected to be more similar. The third row shows Dirichlet-distributed rates. This is a biologically agnostic clustering method for assigning branch rates.
}

\clearpage


\begin{figure}
\centering
\includegraphics[width=\textwidth]{figures/birth-death-trees-v2.pdf}
\caption{\footnotesize See following page for figure legend.
}
\label{fig:birth-death}
\end{figure}

\clearpage


Figure \ref{fig:birth-death} \textbf{The complete versus reconstructed trees under birth-death process models.}
The assumptions of four different models are captured in each row.
The first column shows an example outcome of the joint diversification and sampling processes (i.e. the complete tree), where diamonds represent  extant or fossil samples.
The second column shows the tree that contains sampled lineages only (i.e. the reconstructed tree). 
The third column shows the parameters and the name commonly applied to model used to described the probability of observing the reconstructed tree shown in column two given we assume the generating processes shown in column one.
In all cases we assume constant speciation, extinction and fossil recovery, and uniform extant species sampling.
Trees and fossils were simulated and plotted using the R packages \texttt{TreeSim} \cite{Stadler2011} and \texttt{FossilSim} \cite{BaridoSottani2019b}.
\rw{Do we want to try including the FBD range model in line 5? Or is there enough going on here? How about a different figure for the FBD range model?}
\rw{Font used for model names probably should be larger?}
\aw{I think more models might force us to shrink down in a problematic way. I guess my other question would be for that - how well is the implementation working? If it's working well, I think there's a stronger claim on adding it}


\bibliographystyle{unsrt}
\bibliography{refs}

\end{document}

